import{a as N}from"https://app.framerstatic.com/chunk-35HHB5TS.mjs";import{Q as x,Qa as W,Wc as te,a as L,ab as ee,o as Y,re as ne}from"https://app.framerstatic.com/chunk-DPLENNOO.mjs";import{e as K}from"https://app.framerstatic.com/chunk-7DZRNN4K.mjs";import{Bd as Z,nc as j}from"https://app.framerstatic.com/chunk-3XJVYL4D.mjs";import{ej as M,ga as H,qb as X}from"https://app.framerstatic.com/chunk-O7B2OPHS.mjs";import{a as B,b as g}from"https://app.framerstatic.com/chunk-VJQQCSHI.mjs";import{b}from"https://app.framerstatic.com/chunk-GO7WVIKP.mjs";import{c as _,d as R}from"https://app.framerstatic.com/chunk-Q5MITPIS.mjs";import{b as A,d as D,p as T}from"https://app.framerstatic.com/chunk-NEFK4M7X.mjs";import{a as P}from"https://app.framerstatic.com/chunk-NIDOI5EE.mjs";import{g as U}from"https://app.framerstatic.com/chunk-WDRGG64A.mjs";import{l as v}from"https://app.framerstatic.com/chunk-WWFRYK5U.mjs";import{ea as J,i as Q,l as V,s as q,v as G}from"https://app.framerstatic.com/chunk-35MJ64JF.mjs";import{a as k}from"https://app.framerstatic.com/chunk-WNSBRACC.mjs";import{a as w}from"https://app.framerstatic.com/chunk-LQILWJHN.mjs";import{e as O,j as a}from"https://app.framerstatic.com/chunk-AHQIRSXG.mjs";var z=O(P());function fe(s,e,t){try{let n=localStorage.getItem(s);if(!n)return e;let i=JSON.parse(n);if(typeof i!=typeof e)return e;if(t){if(typeof i!="object")return e;for(let r of Object.keys(i))i[r]=t(r,i[r])}return i}catch{return e}}function Te(s,e,t){let[n,i]=z.default.useState(()=>fe(s,e,t)),r=z.default.useCallback(o=>{i(o),localStorage.setItem(s,JSON.stringify(o))},[s]);return[n,r]}var m=O(P());var re=Symbol("uninitialized");function Fe(s,e,t,n={}){let i=b(),{deepEqual:r=!1}=n,o=Array.isArray(t)?t:[t],p=(0,m.useCallback)(h=>{let c=[...o,h],C=i.scheduler.changes.observe(...c);return()=>i.scheduler.changes.removeObserver(C)},o),u=(0,m.useCallback)(s,e),f=(0,m.useRef)(re),y=(0,m.useCallback)(()=>{let h=f.current,c;return h===re?(c=u(),f.current=c,c):(c=u(),(r?H(h,c):X(h,c))?h:(f.current=c,c))},[r,u]);return(0,m.useSyncExternalStore)(p,y)}var se=O(P());function we(s,e){let t=b();return(0,se.useCallback)(t.scheduler.wrapHandler(s),e)}var ge=3,d=G("PartialTreeSender"),ie=Q();function oe(){return new Promise((s,e)=>{if(typeof MessageChannel<"u"){let t=new MessageChannel;t.port1.onmessage=()=>s(),t.port1.onmessageerror=()=>e(),t.port2.postMessage(null)}else setTimeout(s,0)})}var ae=class{constructor(e,t,n){this.timeline=e;a(this,"name");a(this,"currentScopeId","");a(this,"timelineCursor");a(this,"scopeBufferMap",new Map);a(this,"chunkQueue",[]);a(this,"chunkIndex",0);a(this,"chunkingConfig");a(this,"drainingPromise");this.name=t+"-"+String(Math.round(Math.random()*1e3)),this.chunkingConfig={maxNodesPerChunk:n?.maxNodesPerChunk??1e3}}shouldUseChunking(e,t){if(this.timelineCursor)return!1;let n=e.chunkingHints;if(!n||n.size===0)return!1;let i=E();t&&i.add(t);for(let r of i)if(n.has(r))return d.debug(this.name,`chunking required - large page hint: ${r}`),!0;return!1}serializeTreeChunks(e,t){let n=[],i=crypto.randomUUID(),r=new Map,o=new Map,p=0,u=E();t&&u.add(t);let f=()=>{r.size>0&&(n.push({name:this.name,timestamp:Date.now(),treeChunks:{chunkId:i,chunkIndex:n.length,totalChunks:-1,nodes:r,childrenMap:o,rootId:n.length===0?e.root.id:void 0}}),r=new Map,o=new Map)},y=l=>{let F=x.valueFromNode(l);r.set(l.id,F);let me=l.children?l.children.map(I=>I.id):[];if(o.set(l.id,me),p++,F.children&&(F.children=ie),r.size>=this.chunkingConfig.maxNodesPerChunk&&f(),l.children)for(let I of l.children)y(I)},h=e.root,c,C={};for(c in h)M[c]||(C[c]=h[c]);let $=e.getNodes(u),le={...C,__class:"RootNode",id:e.root.id,children:ie};r.set(e.root.id,le),o.set(e.root.id,$.map(l=>l.id)),p++,r.size>=this.chunkingConfig.maxNodesPerChunk&&f();for(let l of $)y(l);f();let he=n.length;for(let l of n)l.treeChunks.totalChunks=he;return d.debug(this.name,`directly chunked tree into ${n.length} chunks with ${p} total nodes`),n}getNextChunk(){if(this.chunkQueue.length===0)return;let e=this.chunkQueue[this.chunkIndex];return this.chunkIndex++,this.chunkIndex>=this.chunkQueue.length&&(this.chunkQueue=[],this.chunkIndex=0),e}hasMoreChunks(){return k(this.chunkIndex>=0,"Chunk index should not be negative"),k(this.chunkIndex<=this.chunkQueue.length,"Chunk index should not exceed queue length"),this.chunkIndex<this.chunkQueue.length}async*drainChunks(e){if(!this.hasMoreChunks())return;let t=this.drainingPromise;this.drainingPromise=new J,t&&(d.debug(this.name,"drainChunks already in progress, waiting for it to finish"),await t),d.debug(this.name,"drainChunks started");let n=0,i=performance.now();try{for(;this.hasMoreChunks();){if(e?.aborted){d.debug(this.name,"drainChunks aborted, clearing chunk queue"),this.chunkQueue=[],this.chunkIndex=0;return}let r=this.getNextChunk();r&&(n++,d.debug(this.name,`sending chunk ${r.treeChunks.chunkIndex+1} of ${r.treeChunks.totalChunks}`),yield r),await oe()}}finally{await oe(),this.timelineCursor=this.timeline.getChangeTrackingCursor();let r=performance.now()-i,o=r>1e3?`${(r/1e3).toFixed(2)}s`:`${Math.round(r)}ms`;d.debug(this.name,`completed sending ${n} chunks in ${o}`),d.debug(this.name,"drainChunks completed"),this.drainingPromise?.resolve(),this.drainingPromise=void 0}}resetScopeBuffer(e){this.scopeBufferMap.clear(),this.currentScopeId=e??"",e&&(this.timelineCursor=void 0,this.scopeBufferMap.set(e,performance.now()))}updateScopeBuffer(e){if(this.currentScopeId===e)return[void 0,void 0];if(e===L)return[void 0,void 0];if(this.currentScopeId=e,this.scopeBufferMap.has(this.currentScopeId))return this.scopeBufferMap.set(this.currentScopeId,performance.now()),[void 0,void 0];let t;if(this.scopeBufferMap.size>=ge){let n=E(),i=1/0,r;for(let[o,p]of this.scopeBufferMap)n.has(o)||i>p&&(i=p,r=o);r&&(this.scopeBufferMap.delete(r),t=r)}return this.scopeBufferMap.set(this.currentScopeId,performance.now()),[t,e]}reset(e){let t=this.timeline.tree;if(this.resetScopeBuffer(e),this.shouldUseChunking(t,e))return this.chunkQueue=this.serializeTreeChunks(t,e),this.chunkIndex=0,d.debug(this.name,"initiated direct chunked transfer for tree"),null;let n=de(t,e);return this.chunkQueue=[],this.chunkIndex=0,n}update(e){if(!e)return{};if(this.hasMoreChunks())return{};let t=this.timeline.tree,n=this.timeline.fetchForwardChanges(this.timelineCursor);if(!n){if(this.timeline.invalidatedByLoadCompletedDocument(this.timelineCursor))return d.debug(this.name,"cursor invalidated, sending empty update for load completed document"),this.timelineCursor=this.timeline.getChangeTrackingCursor(),{};if(this.resetScopeBuffer(e),this.shouldUseChunking(t,e)){this.chunkQueue=this.serializeTreeChunks(t,e),this.chunkIndex=0;let u=this.getNextChunk();if(u)return d.debug(this.name,`starting direct chunked resend with ${this.chunkQueue.length} chunks`),u}let p=de(t,e);return d.debug(this.name,"cursor invalidated, sending tree with scope:",e),this.timelineCursor=this.timeline.getChangeTrackingCursor(),{name:this.name,tree:p,timestamp:Date.now()}}let[i,r]=this.updateScopeBuffer(e);i&&(d.debug(this.name,"deleting scope by diff:",i),ue(i,n)),n.length===0&&(n=void 0);let o;if(r&&(d.debug(this.name,"adding scope by subtree:",r),o=this.getScopeSubTree(t,r)),n){let p=this.getAffectedScopeIDsAfterCrossScopeMove(t,n);for(let u of p){if(u!==this.currentScopeId){this.scopeBufferMap.has(u)&&(d.debug(this.name,"deleting scope due to cross-scope move:",u),ue(u,n),this.scopeBufferMap.delete(u));continue}o||(d.debug(this.name,"resending tree with scope due to cross-scope move:",u),o=this.getScopeSubTree(t,u))}}return{changes:n,scopes:o?[o]:void 0,timestamp:Date.now()}}getScopeSubTree(e,t){let n=e.get(t);return K(n)&&k(n.isLoaded(),"Scope must be loaded"),Se(n)}getAffectedScopeIDsAfterCrossScopeMove(e,t){let n=new Set;for(let i of t){if(!i.previousScope||!i.to.parentid)continue;let r=e.get(i.id),o=e.getScopeNodeFor(r);o&&n.add(o.id)}return n}};function ue(s,e){e.push({id:s,removed:"CanvasNode",to:{}})}function Se(s){if(s)return x.valueFromNode(s)}function E(){return new Set([te,W,ne,Z,ee,L])}function de(s,e){let t=E();e&&t.add(e);let n=s.getNodes(t).map(p=>x.valueFromNode(p)),i=s.root,r,o={};for(r in i)M[r]||(o[r]=i[r]);return{version:Y,root:{...o,__class:"RootNode",id:s.root.id,children:n}}}var ye=/<([a-z1-9]+)/gi;function We(s){let e=new Set;return Ce(s,e),e}function Ce(s,e){let t=s.matchAll(ye);for(let[,n]of t)n&&e.add(n);return e}var S=class{constructor(e){this.callbacks=e;a(this,"experimentListeners",new Map);a(this,"employeesOnlySettingsListeners",new Map);a(this,"projectFeaturesListeners",new Map)}startUpdatesStream(){Object.keys(D).forEach(e=>{let t=n=>{this.callbacks.updateExperiments({[e]:n})};T.addListener(e,t),this.experimentListeners.set(e,t)}),Object.keys(A).forEach(e=>{let t=n=>{this.callbacks.updateEmployeesOnlySettings({[e]:n})};N.addListener(e,t),this.employeesOnlySettingsListeners.set(e,t)})}getInitialExperiments(){let e={};return Object.keys(D).forEach(t=>{e[t]=T.get(t)}),e}getInitialEmployeesOnlySettings(){let e={};return Object.keys(A).forEach(t=>{e[t]=N.get(t)}),e}initProjectFeatures(){g.updated.then(()=>{let e={};Object.keys(B).forEach(t=>{e[t]=g.get(t)}),this.callbacks.updateProjectFeatures(e),this.projectFeaturesListeners.size===0&&Object.keys(B).forEach(t=>{let n=i=>{this.callbacks.updateProjectFeatures({[t]:i})};g.addListener(t,n),this.projectFeaturesListeners.set(t,n)})}).catch(V)}stopUpdatesStream(){for(let[e,t]of this.experimentListeners)T.removeListener(e,t);for(let[e,t]of this.employeesOnlySettingsListeners)N.removeListener(e,t);for(let[e,t]of this.projectFeaturesListeners)g.removeListener(e,t);this.experimentListeners.clear(),this.employeesOnlySettingsListeners.clear(),this.projectFeaturesListeners.clear()}},ce=class{constructor(e){this.remoteFlags=e;let t=new S(this.remoteFlags);t.startUpdatesStream(),this.remoteFlags.updateExperiments(t.getInitialExperiments()),this.remoteFlags.updateEmployeesOnlySettings(t.getInitialEmployeesOnlySettings())}};var lt=q({canvas:()=>{let s=ke();return R(s),_(s)},onPageCanvas:()=>{let s=ve();return R(s),_(s)}});function ke(){let s=U.isDebugBuild?"canvas-sandbox.debug.html":"canvas-sandbox.html",e=j(`./${s}`),t=JSON.stringify(w());return e+`#services=${encodeURIComponent(t)}`}function ve(){let s=U.isDebugBuild?"canvas-sandbox-on-page.debug.html":"canvas-sandbox-on-page.html",e=j(`./${s}`),t=JSON.stringify(w());return e+`#services=${encodeURIComponent(t)}`}var pe=class{constructor(){a(this,"experimentsUpdatesEmitter",new v);a(this,"employeesOnlySettingsUpdatesEmitter",new v);a(this,"projectFeaturesUpdatesEmitter",new v);a(this,"flagsUpdater",new S(this));this.flagsUpdater.startUpdatesStream(),this.experimentsUpdatesEmitter.onNewStream=e=>{if(e?.replay==="latest")return{latest:this.flagsUpdater.getInitialExperiments()}},this.employeesOnlySettingsUpdatesEmitter.onNewStream=e=>{if(e?.replay==="latest")return{latest:this.flagsUpdater.getInitialEmployeesOnlySettings()}},this.projectFeaturesUpdatesEmitter.onNewStream=e=>{this.flagsUpdater.initProjectFeatures()}}updateExperiments(e){this.experimentsUpdatesEmitter.emit(e)}updateEmployeesOnlySettings(e){this.employeesOnlySettingsUpdatesEmitter.emit(e)}updateProjectFeatures(e){this.projectFeaturesUpdatesEmitter.emit(e)}stopUpdatesStream(){this.flagsUpdater.stopUpdatesStream()}experimentsUpdatesStream(e){return this.experimentsUpdatesEmitter.newStream(e)}employeesOnlySettingsUpdatesStream(e){return this.employeesOnlySettingsUpdatesEmitter.newStream(e)}projectFeaturesUpdatesStream(e){return this.projectFeaturesUpdatesEmitter.newStream(e)}};export{Fe as a,we as b,Te as c,ce as d,pe as e,lt as f,ae as g,We as h,Ce as i};
//# sourceMappingURL=https://app.framerstatic.com/chunk-VQA3Y4TJ.mjs.map
