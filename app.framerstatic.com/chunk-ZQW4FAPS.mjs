import{a as b}from"https://app.framerstatic.com/chunk-5Q3JIVQX.mjs";import{Q as N,Qa as Z,Uc as ee,a as D,ab as W,o as K,pe as te}from"https://app.framerstatic.com/chunk-YHHLDGNJ.mjs";import{e as X}from"https://app.framerstatic.com/chunk-2YBI3QOI.mjs";import{Cd as Y,nc as M}from"https://app.framerstatic.com/chunk-6US6DZT3.mjs";import{ga as H,hj as A,qb as J}from"https://app.framerstatic.com/chunk-A3XCEWME.mjs";import{a as j,b as g}from"https://app.framerstatic.com/chunk-ZM2TCRVZ.mjs";import{b as T}from"https://app.framerstatic.com/chunk-GO7WVIKP.mjs";import{c as L,d as _}from"https://app.framerstatic.com/chunk-D76S3G46.mjs";import{b as U,d as P,p as x}from"https://app.framerstatic.com/chunk-W5VAAB5H.mjs";import{a as G}from"https://app.framerstatic.com/chunk-NIDOI5EE.mjs";import{g as w}from"https://app.framerstatic.com/chunk-SALNC65Q.mjs";import{l as k}from"https://app.framerstatic.com/chunk-ALLJ3UV4.mjs";import{ea as q,i as z,l as $,s as Q,v as V}from"https://app.framerstatic.com/chunk-7J5JFG4S.mjs";import{a as v}from"https://app.framerstatic.com/chunk-WNSBRACC.mjs";import{a as O}from"https://app.framerstatic.com/chunk-LQILWJHN.mjs";import{e as B,j as a}from"https://app.framerstatic.com/chunk-AHQIRSXG.mjs";var m=B(G());var ne=Symbol("uninitialized");function Te(s,e,t,n={}){let i=T(),{deepEqual:r=!1}=n,o=Array.isArray(t)?t:[t],p=(0,m.useCallback)(h=>{let c=[...o,h],C=i.scheduler.changes.observe(...c);return()=>i.scheduler.changes.removeObserver(C)},o),u=(0,m.useCallback)(s,e),f=(0,m.useRef)(ne),S=(0,m.useCallback)(()=>{let h=f.current,c;return h===ne?(c=u(),f.current=c,c):(c=u(),(r?H(h,c):J(h,c))?h:(f.current=c,c))},[r,u]);return(0,m.useSyncExternalStore)(p,S)}var re=B(G());function Ee(s,e){let t=T();return(0,re.useCallback)(t.scheduler.wrapHandler(s),e)}var me=3,d=V("PartialTreeSender"),se=z();function ie(){return new Promise((s,e)=>{if(typeof MessageChannel<"u"){let t=new MessageChannel;t.port1.onmessage=()=>s(),t.port1.onmessageerror=()=>e(),t.port2.postMessage(null)}else setTimeout(s,0)})}var oe=class{constructor(e,t,n){this.timeline=e;a(this,"name");a(this,"currentScopeId","");a(this,"timelineCursor");a(this,"scopeBufferMap",new Map);a(this,"chunkQueue",[]);a(this,"chunkIndex",0);a(this,"chunkingConfig");a(this,"drainingPromise");this.name=t+"-"+String(Math.round(Math.random()*1e3)),this.chunkingConfig={maxNodesPerChunk:n?.maxNodesPerChunk??1e3}}shouldUseChunking(e,t){if(this.timelineCursor)return!1;let n=e.chunkingHints;if(!n||n.size===0)return!1;let i=E();t&&i.add(t);for(let r of i)if(n.has(r))return d.debug(this.name,`chunking required - large page hint: ${r}`),!0;return!1}serializeTreeChunks(e,t){let n=[],i=crypto.randomUUID(),r=new Map,o=new Map,p=0,u=E();t&&u.add(t);let f=()=>{r.size>0&&(n.push({name:this.name,timestamp:Date.now(),treeChunks:{chunkId:i,chunkIndex:n.length,totalChunks:-1,nodes:r,childrenMap:o,rootId:n.length===0?e.root.id:void 0}}),r=new Map,o=new Map)},S=l=>{let F=N.valueFromNode(l);r.set(l.id,F);let he=l.children?l.children.map(I=>I.id):[];if(o.set(l.id,he),p++,F.children&&(F.children=se),r.size>=this.chunkingConfig.maxNodesPerChunk&&f(),l.children)for(let I of l.children)S(I)},h=e.root,c,C={};for(c in h)A[c]||(C[c]=h[c]);let R=e.getNodes(u),pe={...C,__class:"RootNode",id:e.root.id,children:se};r.set(e.root.id,pe),o.set(e.root.id,R.map(l=>l.id)),p++,r.size>=this.chunkingConfig.maxNodesPerChunk&&f();for(let l of R)S(l);f();let le=n.length;for(let l of n)l.treeChunks.totalChunks=le;return d.debug(this.name,`directly chunked tree into ${n.length} chunks with ${p} total nodes`),n}getNextChunk(){if(this.chunkQueue.length===0)return;let e=this.chunkQueue[this.chunkIndex];return this.chunkIndex++,this.chunkIndex>=this.chunkQueue.length&&(this.chunkQueue=[],this.chunkIndex=0),e}hasMoreChunks(){return v(this.chunkIndex>=0,"Chunk index should not be negative"),v(this.chunkIndex<=this.chunkQueue.length,"Chunk index should not exceed queue length"),this.chunkIndex<this.chunkQueue.length}async*drainChunks(e){if(!this.hasMoreChunks())return;let t=this.drainingPromise;this.drainingPromise=new q,t&&(d.debug(this.name,"drainChunks already in progress, waiting for it to finish"),await t),d.debug(this.name,"drainChunks started");let n=0,i=performance.now();try{for(;this.hasMoreChunks();){if(e?.aborted){d.debug(this.name,"drainChunks aborted, clearing chunk queue"),this.chunkQueue=[],this.chunkIndex=0;return}let r=this.getNextChunk();r&&(n++,d.debug(this.name,`sending chunk ${r.treeChunks.chunkIndex+1} of ${r.treeChunks.totalChunks}`),yield r),await ie()}}finally{await ie(),this.timelineCursor=this.timeline.getChangeTrackingCursor();let r=performance.now()-i,o=r>1e3?`${(r/1e3).toFixed(2)}s`:`${Math.round(r)}ms`;d.debug(this.name,`completed sending ${n} chunks in ${o}`),d.debug(this.name,"drainChunks completed"),this.drainingPromise?.resolve(),this.drainingPromise=void 0}}resetScopeBuffer(e){this.scopeBufferMap.clear(),this.currentScopeId=e??"",e&&(this.timelineCursor=void 0,this.scopeBufferMap.set(e,performance.now()))}updateScopeBuffer(e){if(this.currentScopeId===e)return[void 0,void 0];if(e===D)return[void 0,void 0];if(this.currentScopeId=e,this.scopeBufferMap.has(this.currentScopeId))return this.scopeBufferMap.set(this.currentScopeId,performance.now()),[void 0,void 0];let t;if(this.scopeBufferMap.size>=me){let n=E(),i=1/0,r;for(let[o,p]of this.scopeBufferMap)n.has(o)||i>p&&(i=p,r=o);r&&(this.scopeBufferMap.delete(r),t=r)}return this.scopeBufferMap.set(this.currentScopeId,performance.now()),[t,e]}reset(e){let t=this.timeline.tree;if(this.resetScopeBuffer(e),this.shouldUseChunking(t,e))return this.chunkQueue=this.serializeTreeChunks(t,e),this.chunkIndex=0,d.debug(this.name,"initiated direct chunked transfer for tree"),null;let n=ue(t,e);return this.chunkQueue=[],this.chunkIndex=0,n}update(e){if(!e)return{};if(this.hasMoreChunks())return{};let t=this.timeline.tree,n=this.timeline.fetchForwardChanges(this.timelineCursor);if(!n){if(this.timeline.invalidatedByLoadCompletedDocument(this.timelineCursor))return d.debug(this.name,"cursor invalidated, sending empty update for load completed document"),this.timelineCursor=this.timeline.getChangeTrackingCursor(),{};if(this.resetScopeBuffer(e),this.shouldUseChunking(t,e)){this.chunkQueue=this.serializeTreeChunks(t,e),this.chunkIndex=0;let u=this.getNextChunk();if(u)return d.debug(this.name,`starting direct chunked resend with ${this.chunkQueue.length} chunks`),u}let p=ue(t,e);return d.debug(this.name,"cursor invalidated, sending tree with scope:",e),this.timelineCursor=this.timeline.getChangeTrackingCursor(),{name:this.name,tree:p,timestamp:Date.now()}}let[i,r]=this.updateScopeBuffer(e);i&&(d.debug(this.name,"deleting scope by diff:",i),ae(i,n)),n.length===0&&(n=void 0);let o;if(r&&(d.debug(this.name,"adding scope by subtree:",r),o=this.getScopeSubTree(t,r)),n){let p=this.getAffectedScopeIDsAfterCrossScopeMove(t,n);for(let u of p){if(u!==this.currentScopeId){this.scopeBufferMap.has(u)&&(d.debug(this.name,"deleting scope due to cross-scope move:",u),ae(u,n),this.scopeBufferMap.delete(u));continue}o||(d.debug(this.name,"resending tree with scope due to cross-scope move:",u),o=this.getScopeSubTree(t,u))}}return{changes:n,scopes:o?[o]:void 0,timestamp:Date.now()}}getScopeSubTree(e,t){let n=e.get(t);return X(n)&&v(n.isLoaded(),"Scope must be loaded"),fe(n)}getAffectedScopeIDsAfterCrossScopeMove(e,t){let n=new Set;for(let i of t){if(!i.previousScope||!i.to.parentid)continue;let r=e.get(i.id),o=e.getScopeNodeFor(r);o&&n.add(o.id)}return n}};function ae(s,e){e.push({id:s,removed:"CanvasNode",to:{}})}function fe(s){if(s)return N.valueFromNode(s)}function E(){return new Set([ee,Z,te,Y,W,D])}function ue(s,e){let t=E();e&&t.add(e);let n=s.getNodes(t).map(p=>N.valueFromNode(p)),i=s.root,r,o={};for(r in i)A[r]||(o[r]=i[r]);return{version:K,root:{...o,__class:"RootNode",id:s.root.id,children:n}}}var ge=/<([a-z1-9]+)/gi;function Xe(s){let e=new Set;return ye(s,e),e}function ye(s,e){let t=s.matchAll(ge);for(let[,n]of t)n&&e.add(n);return e}var y=class{constructor(e){this.callbacks=e;a(this,"experimentListeners",new Map);a(this,"employeesOnlySettingsListeners",new Map);a(this,"projectFeaturesListeners",new Map)}startUpdatesStream(){Object.keys(P).forEach(e=>{let t=n=>{this.callbacks.updateExperiments({[e]:n})};x.addListener(e,t),this.experimentListeners.set(e,t)}),Object.keys(U).forEach(e=>{let t=n=>{this.callbacks.updateEmployeesOnlySettings({[e]:n})};b.addListener(e,t),this.employeesOnlySettingsListeners.set(e,t)})}getInitialExperiments(){let e={};return Object.keys(P).forEach(t=>{e[t]=x.get(t)}),e}getInitialEmployeesOnlySettings(){let e={};return Object.keys(U).forEach(t=>{e[t]=b.get(t)}),e}initProjectFeatures(){g.updated.then(()=>{let e={};Object.keys(j).forEach(t=>{e[t]=g.get(t)}),this.callbacks.updateProjectFeatures(e),this.projectFeaturesListeners.size===0&&Object.keys(j).forEach(t=>{let n=i=>{this.callbacks.updateProjectFeatures({[t]:i})};g.addListener(t,n),this.projectFeaturesListeners.set(t,n)})}).catch($)}stopUpdatesStream(){for(let[e,t]of this.experimentListeners)x.removeListener(e,t);for(let[e,t]of this.employeesOnlySettingsListeners)b.removeListener(e,t);for(let[e,t]of this.projectFeaturesListeners)g.removeListener(e,t);this.experimentListeners.clear(),this.employeesOnlySettingsListeners.clear(),this.projectFeaturesListeners.clear()}},de=class{constructor(e){this.remoteFlags=e;let t=new y(this.remoteFlags);t.startUpdatesStream(),this.remoteFlags.updateExperiments(t.getInitialExperiments()),this.remoteFlags.updateEmployeesOnlySettings(t.getInitialEmployeesOnlySettings())}};var ut=Q({canvas:()=>{let s=Se();return _(s),L(s)},onPageCanvas:()=>{let s=Ce();return _(s),L(s)}});function Se(){let s=w.isDebugBuild?"canvas-sandbox.debug.html":"canvas-sandbox.html",e=M(`./${s}`),t=JSON.stringify(O());return e+`#services=${encodeURIComponent(t)}`}function Ce(){let s=w.isDebugBuild?"canvas-sandbox-on-page.debug.html":"canvas-sandbox-on-page.html",e=M(`./${s}`),t=JSON.stringify(O());return e+`#services=${encodeURIComponent(t)}`}var ce=class{constructor(){a(this,"experimentsUpdatesEmitter",new k);a(this,"employeesOnlySettingsUpdatesEmitter",new k);a(this,"projectFeaturesUpdatesEmitter",new k);a(this,"flagsUpdater",new y(this));this.flagsUpdater.startUpdatesStream(),this.experimentsUpdatesEmitter.onNewStream=e=>{if(e?.replay==="latest")return{latest:this.flagsUpdater.getInitialExperiments()}},this.employeesOnlySettingsUpdatesEmitter.onNewStream=e=>{if(e?.replay==="latest")return{latest:this.flagsUpdater.getInitialEmployeesOnlySettings()}},this.projectFeaturesUpdatesEmitter.onNewStream=e=>{this.flagsUpdater.initProjectFeatures()}}updateExperiments(e){this.experimentsUpdatesEmitter.emit(e)}updateEmployeesOnlySettings(e){this.employeesOnlySettingsUpdatesEmitter.emit(e)}updateProjectFeatures(e){this.projectFeaturesUpdatesEmitter.emit(e)}stopUpdatesStream(){this.flagsUpdater.stopUpdatesStream()}experimentsUpdatesStream(e){return this.experimentsUpdatesEmitter.newStream(e)}employeesOnlySettingsUpdatesStream(e){return this.employeesOnlySettingsUpdatesEmitter.newStream(e)}projectFeaturesUpdatesStream(e){return this.projectFeaturesUpdatesEmitter.newStream(e)}};export{Te as a,Ee as b,de as c,ce as d,ut as e,oe as f,Xe as g,ye as h};
//# sourceMappingURL=https://app.framerstatic.com/chunk-ZQW4FAPS.mjs.map
